secrets: flexget-secret.yml
templates:
  # find all downloaded video files
  find_downloaded_video_files:
    filesystem:
      path: /storage/Descargas
      regexp: '.*\.(avi|mkv|mp4)$'
      recursive: yes
  # ensure that location has subtitle
  ensure_subtitles:
    disable:
      - seen
      - seen_info_hash
    accept_all: yes
    all_series:
      parse_only: yes
    exec:
      fail_entries: yes
      auto_escape: yes
      on_filter:
        for_entries: 'has_subtitle "{{location}}"'
  # ensure that location doest have subtitle
  ensure_no_subtitles:
    template:
      - ensure_subtitles
    exec:
      on_filter:
        for_entries: '! has_subtitle "{{location}}"'

tasks:
  # downloading task
  download-rss:
    rss: http://showrss.info/rss.php?user_id=201004&hd=null&proper=null 
    # fetch all the feed series
    all_series: yes
    priority: 1
    regexp:
      reject:
        - FASTSUB
        - VOSTFR
        - Subtitulado
    content_filter:
      reject:
        - '*.rar'
        - '*.zip'
    transmission:
      host: '{{ secrets.transmission.host }}'
      port: 8181
      username: '{{ secrets.transmission.username }}'
      password: '{{ secrets.transmission.password }}'
    
  # descarga de subtitulos
  donwload-subtitles:
    priority: 10
    template:
      - find_downloaded_video_files
      - ensure_no_subtitles
    disable:
      - backlog
    retry_failed:
      max_retries: 100
    subliminal:
      languages:
        - eng
      exact_match: yes

  # sorting task
  sort-series:
    priority: 20
    disable:
      - retry_failed
    template: 
      - find_downloaded_video_files
      - ensure_subtitles
    thetvdb_lookup: yes
    require_field: [series_id]
    series:
      settings:
        numeracion_especial:
          parse_only: yes
          ep_regexp:
            - (\d\d)(\d\d)
            - (\d)(\d\d)
      numeracion_especial:
        - The Big Bang Theory
        - Modern Family
    move:
      to: "/storage/Series/{{ tvdb_series_name }}/Season {{series_season|pad(2)}}"
      filename: '{{ tvdb_series_name }}-{{ series_id }}-{{ tvdb_ep_name }}{{ location | pathext }}'
      along:
        - srt
        - en.srt
        - eng.srt  
      clean_source: 100
  # sort movies
  sort-movies:
    priority: 21
    disable:
      - retry_failed
    template: 
      - find_downloaded_video_files
      - ensure_subtitles
    imdb_lookup: yes
    proper_movies: yes
    require_field: [movie_name, movie_year]
    move:
      to: "/storage/Peliculas/{{ movie_name|replace('/', '_')|replace(':', ' -')|replace(',', '') }} ({{ movie_year }})/"
      filename: "{{ movie_name|replace('/', '_')|replace(':', ' -')|replace(',', '') }} ({{ movie_year }}) - {{ quality }}.{{ location[-3:] }}"
      along:
        - srt
        - en.srt
        - eng.srt  
      clean_source: 100
  # cleans completed torrents
  clean-complete-torrents:
    priority: 5
    clean_transmission:
      host: '{{ secrets.transmission.host }}'
      port: 8181
      username: '{{ secrets.transmission.username }}'
      password: '{{ secrets.transmission.password }}'
      finished_for: 2 hours
      transmission_seed_limits: yes
    disable: details
